---
import { getCollection } from 'astro:content'
import { Image } from 'astro:assets'
import Layout from '../../layouts/Layout.astro'
import { formatBakes, WORKER_BASE } from '../../utils'

const fmt = (dateStr: string) =>
  new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    day: 'numeric',
    month: 'short',
  }).format(new Date(dateStr))

export async function getStaticPaths() {
  const bakes = formatBakes(await getCollection('bakes'))
  bakes.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

  return bakes.map((bake, i) => ({
    params: { id: bake.id },
    props: {
      bake,
      prev: bakes[i + 1] || null,
      next: bakes[i - 1] || null,
    },
  }))
}

const { bake, prev, next } = Astro.props
const { data } = bake

const formatted = fmt(data.bake_date)
const ingredients = data.ingredients.toSorted((a, b) => a.sort_order - b.sort_order)
const schedule = data.schedule.toSorted((a, b) => a.sort_order - b.sort_order)
const ogImages = data.photos.length > 0 ? data.photos.map((p) => `${WORKER_BASE}${p.url}`) : undefined
---

<Layout
  article={true}
  title={`${data.title || formatted} - Baking Log`}
  description={`Bake from ${formatted}`}
  image={ogImages}
>

  <main class="container">
    <div class="section">
      <a class="bake-back" href="/baking">← All bakes</a>

      <h1>{data.title || 'Bake Log'}</h1>
      <div class="blog__meta">
        <span class="blog__date">{formatted}</span>
      </div>

      <div class="content">
        <h2>Ingredients</h2>
        <ul>
          {
            ingredients.map((ing) => (
              <li>
                {ing.amount} {ing.name}
                {ing.note && <span> — {ing.note}</span>}
              </li>
            ))
          }
        </ul>
        {data.ingredients_text && <p>{data.ingredients_text}</p>}

        <h2>Schedule</h2>
        <ul>
          {
            schedule.map((entry) => (
              <li>
                <strong>{entry.time}</strong> {entry.action}
                {entry.note && <span> — {entry.note}</span>}
              </li>
            ))
          }
        </ul>

        {
          data.notes && (
            <>
              <h2>Notes</h2>
              <p>{data.notes}</p>
            </>
          )
        }

        {
          data.photos.length > 0 && (
            <div class="bake-photos">
              {data.photos.map((photo) => (
                <Image
                  src={`${WORKER_BASE}${photo.url}`}
                  alt={photo.caption || `Bake from ${formatted}`}
                  width={1200}
                  height={1200}
                  quality="high"
                  loading="lazy"
                />
              ))}
            </div>
          )
        }
      </div>

      <nav class="bake-nav">
        {prev ? <a href={`/baking/${prev.id}`}>← prev</a> : <span />}
        {next ? <a href={`/baking/${next.id}`}>next →</a> : <span />}
      </nav>
    </div>
  </main>
</Layout>
